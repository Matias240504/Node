<!DOCTYPE html>
<html lang="es">
<head>
    <%- include('./partials/styles',{title:'Notificaciones'}) %>
    <style>
        .notif-container{max-width:800px;margin:40px auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1);}        
        .notif{border-bottom:1px solid #ddd;padding:10px 0;cursor:pointer;}
        .notif.leida{opacity:0.6;}
        .notif:last-child{border:none;}
        .notif h4{margin:0;}
        .notif small{color:#666;}
        .page-title{color:#000;font-weight:700;margin:0;}
    </style>
</head>
<body>
 <div class="dashboard-container">
    <%- include('./partials/sidebar',{currentPath:'/cliente/notificaciones',user:user}) %>
    <div class="main-content">
        <div class="page-header" style="display:flex;justify-content:space-between;align-items:center;">
          <h2 class="page-title">Notificaciones</h2>
          <span id="currentDate"></span>
        </div>
        <div class="notif-container" id="notifList"></div>
    </div>
 </div>

 <div id="modal" class="modal" style="display:none;">
   <div class="modal-content" style="max-width:600px;">
     <span id="closeModal" class="close">&times;</span>
     <h3 id="modalTitulo"></h3>
     <div id="modalDatos" style="white-space:pre-wrap;"></div>
   </div>
 </div>
 <script>
 async function cargar(){
   const res=await fetch('/cliente/api/notificaciones');
   const data=await res.json();
   const cont=document.getElementById('notifList');
   cont.innerHTML='';
   data.forEach(n=>{
     const div=document.createElement('div');
     div.className='notif'+(n.leido?' leida':'');
     let extra='';
     if(n.tipo==='audiencia' && n.datos){
        const fechaAud = n.datos.fecha? new Date(n.datos.fecha):null;
        const fechaTexto = fechaAud? `${fechaAud.toLocaleDateString()} ${n.datos.hora||fechaAud.toLocaleTimeString()}`: new Date(n.fecha).toLocaleString();
        extra=`<br><small>Sala: ${n.datos.sala||'N/A'} | Abogado: ${n.datos.abogado||'N/A'}</small>`;
     }
     const fechaMostrar = (n.tipo==='audiencia' && n.datos && n.datos.fecha)? `${new Date(n.datos.fecha).toLocaleDateString()} ${n.datos.hora||''}` : new Date(n.fecha).toLocaleString();
     div.innerHTML=`<h4>${n.titulo}</h4><small>${fechaMostrar}</small>${extra}`;
     div.onclick=()=>mostrarDetalle(n);
     cont.appendChild(div);
   });
 }
 function mostrarDetalle(n){
   document.getElementById('modalTitulo').textContent=n.titulo;
   const detalle=document.getElementById('modalDatos');
   if(n.tipo==='audiencia' && n.datos){
      detalle.innerHTML=`<p><strong>Sala:</strong> ${n.datos.sala||'N/A'}</p>
                         <p><strong>Abogado:</strong> ${n.datos.abogado||'N/A'}</p>
                         <p><strong>Fecha:</strong> ${new Date(n.datos.fecha).toLocaleDateString()}</p>
                         <p><strong>Hora:</strong> ${n.datos.hora||''}</p>`;
   }else{
      detalle.textContent=JSON.stringify(n.datos,null,2);
   }
   document.getElementById('modal').style.display='block';
   fetch(`/cliente/api/notificaciones/${n._id}/leido`,{method:'PATCH'}).then(()=>cargar());
 }
 document.getElementById('closeModal').onclick=()=>document.getElementById('modal').style.display='none';
 window.onclick=e=>{if(e.target.id==='modal')document.getElementById('modal').style.display='none';};
 
 // mostrar fecha actual
 function mostrarFechaActual(){
   const opciones={ weekday:'long', year:'numeric', month:'long', day:'numeric' };
   const fecha=new Date().toLocaleDateString('es-ES',opciones);
   document.getElementById('currentDate').textContent=capitalizar(fecha);
 }
 function capitalizar(texto){return texto.replace(/\b\w/g,l=>l.toUpperCase());}

 document.addEventListener('DOMContentLoaded',()=>{
   cargar();
   mostrarFechaActual();
 });
 </script>
</body>
</html>
