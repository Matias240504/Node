<!DOCTYPE html>
<html lang="es">
<head>
    <%- include('./partials/styles', {title: 'Mis Datos - Abogado'}) %>
    <style>
        /* Estilos específicos para la página de mis datos */
        .profile-container {
            background-color: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            background-color: var(--primary-light);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 25px;
            border: 3px solid var(--primary-color);
        }
        
        .profile-avatar i {
            font-size: 3rem;
            color: var(--primary-color);
        }
        
        .profile-title h2 {
            margin: 0 0 5px 0;
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        
        .profile-title p {
            margin: 0;
            color: var(--text-secondary-color);
            font-size: 1rem;
        }
        
        .profile-info {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .info-group {
            margin-bottom: 20px;
        }
        
        .info-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-secondary-color);
            font-size: 0.9rem;
        }
        
        .info-group .info-value {
            font-size: 1.1rem;
            color: var(--text-color);
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: var(--radius-sm);
            border: 1px solid #eee;
        }
        
        .form-section {
            background-color: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            padding: 30px;
        }
        
        .form-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 1.5rem;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--radius-sm);
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        .form-group .error-message {
            color: var(--danger-color);
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 30px;
        }
        
        .btn-save {
            padding: 12px 25px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-save:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
        }
        
        .btn-save i {
            font-size: 0.9rem;
        }
        
        .alert {
            padding: 15px;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background-color: rgba(46, 204, 113, 0.15);
            border: 1px solid rgba(46, 204, 113, 0.3);
            color: #27ae60;
        }
        
        .alert-error {
            background-color: rgba(231, 76, 60, 0.15);
            border: 1px solid rgba(231, 76, 60, 0.3);
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <%- include('./partials/sidebar', {currentPath: '/abogado/mis-datos'}) %>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="page-header">
                <h2 class="page-title">Mis Datos Profesionales</h2>
                <div>
                    <span id="currentDate"></span>
                </div>
            </div>
            
            <!-- Alertas para mensajes de éxito o error -->
            <div id="alertSuccess" class="alert alert-success">
                <i class="fas fa-check-circle"></i> Datos actualizados correctamente.
            </div>
            
            <div id="alertError" class="alert alert-error">
                <i class="fas fa-exclamation-circle"></i> <span id="errorMessage">Ha ocurrido un error al actualizar los datos.</span>
            </div>
            
            <!-- Información del perfil -->
            <div class="profile-container">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="profile-title">
                        <h2 id="nombreCompleto"><%= user.nombre %> <%= user.apellido %></h2>
                        <p>Abogado</p>
                    </div>
                </div>
                
                <div class="profile-info">
                    <div class="info-group">
                        <label>DNI</label>
                        <div class="info-value" id="dniValue"><%= user.dni || 'No especificado' %></div>
                    </div>
                    
                    <div class="info-group">
                        <label>Email</label>
                        <div class="info-value" id="emailValue"><%= user.email || 'No especificado' %></div>
                    </div>
                    
                    <div class="info-group">
                        <label>Teléfono</label>
                        <div class="info-value" id="telefonoValue"><%= user.telefono || 'No especificado' %></div>
                    </div>
                    
                    <div class="info-group">
                        <label>Dirección</label>
                        <div class="info-value" id="direccionValue"><%= user.direccion || 'No especificada' %></div>
                    </div>
                    
                    <div class="info-group">
                        <label>Especialidad</label>
                        <div class="info-value" id="especialidadValue"><%= user.especialidad || 'No especificada' %></div>
                    </div>
                    
                    <div class="info-group">
                        <label>Número de Colegiatura</label>
                        <div class="info-value" id="colegiaturaValue"><%= user.colegiatura || 'No especificado' %></div>
                    </div>
                    
                    <div class="info-group">
                        <label>Fecha de Registro</label>
                        <div class="info-value" id="fechaRegistroValue"><%= new Date(user.fechaRegistro).toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: 'numeric'}) %></div>
                    </div>
                </div>
            </div>
            
            <!-- Formulario para actualizar datos profesionales -->
            <div class="form-section">
                <h3>Actualizar Datos Profesionales</h3>
                
                <form id="updateProfileForm">
                    <div class="form-group">
                        <label for="especialidad">Especialidad *</label>
                        <input type="text" id="especialidad" name="especialidad" value="<%= user.especialidad || '' %>" placeholder="Ej: Derecho Civil, Penal, Laboral, etc." required>
                        <div class="error-message" id="especialidadError">Por favor ingrese su especialidad.</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="colegiatura">Número de Colegiatura *</label>
                        <input type="text" id="colegiatura" name="colegiatura" value="<%= user.colegiatura || '' %>" placeholder="Ingrese su número de colegiatura (10 dígitos)" required>
                        <div class="error-message" id="colegiaturaError">El número de colegiatura debe tener 10 dígitos numéricos.</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="telefono">Teléfono de Contacto</label>
                        <input type="tel" id="telefono" name="telefono" value="<%= user.telefono || '' %>" placeholder="Ingrese su número de teléfono">
                        <div class="error-message" id="telefonoError">Por favor ingrese un número de teléfono válido.</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="direccion">Dirección Profesional</label>
                        <input type="text" id="direccion" name="direccion" value="<%= user.direccion || '' %>" placeholder="Ingrese su dirección profesional">
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn-save">
                            <i class="fas fa-save"></i> Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <%- include('./partials/scripts') %>
    
    <script>
        // Mostrar fecha actual
        function mostrarFechaActual() {
            const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const fecha = new Date().toLocaleDateString('es-ES', opciones);
            document.getElementById('currentDate').textContent = capitalizar(fecha);
        }
        
        // Función para capitalizar texto
        function capitalizar(texto) {
            return texto.replace(/\b\w/g, function(l) { return l.toUpperCase(); });
        }
        
        // Mostrar fecha al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            mostrarFechaActual();
            
            // Validación del formulario
            const form = document.getElementById('updateProfileForm');
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validar campos
                let isValid = true;
                
                // Validar especialidad
                const especialidad = document.getElementById('especialidad').value.trim();
                if (!especialidad) {
                    document.getElementById('especialidadError').style.display = 'block';
                    isValid = false;
                } else {
                    document.getElementById('especialidadError').style.display = 'none';
                }
                
                // Validar colegiatura (10 dígitos)
                const colegiatura = document.getElementById('colegiatura').value.trim();
                if (!colegiatura || !/^\d{10}$/.test(colegiatura)) {
                    document.getElementById('colegiaturaError').style.display = 'block';
                    isValid = false;
                } else {
                    document.getElementById('colegiaturaError').style.display = 'none';
                }
                
                // Validar teléfono (opcional pero si se proporciona debe ser válido)
                const telefono = document.getElementById('telefono').value.trim();
                if (telefono && !/^\+?[\d\s-]{7,15}$/.test(telefono)) {
                    document.getElementById('telefonoError').style.display = 'block';
                    isValid = false;
                } else {
                    document.getElementById('telefonoError').style.display = 'none';
                }
                
                // Si el formulario es válido, enviar datos
                if (isValid) {
                    actualizarDatosProfesionales();
                }
            });
        });
        
        // Función para actualizar los datos profesionales
        async function actualizarDatosProfesionales() {
            const token = localStorage.getItem('token') || getCookie('token');
            console.log('Token obtenido:', token ? 'Token presente' : 'Token ausente');
            
            if (!token) {
                mostrarError('No se ha podido verificar su identidad. Por favor, inicie sesión nuevamente.');
                return;
            }
            
            const datosActualizados = {
                especialidad: document.getElementById('especialidad').value.trim(),
                colegiatura: document.getElementById('colegiatura').value.trim(),
                telefono: document.getElementById('telefono').value.trim(),
                direccion: document.getElementById('direccion').value.trim()
            };
            
            console.log('Datos a enviar:', datosActualizados);
            
            try {
                console.log('Enviando solicitud a /abogado/api/actualizar-datos');
                const response = await fetch('/abogado/api/actualizar-datos', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(datosActualizados)
                });
                
                console.log('Respuesta recibida, status:', response.status);
                const data = await response.json();
                console.log('Datos recibidos:', data);
                
                if (response.ok) {
                    // Actualizar los valores mostrados en el perfil
                    document.getElementById('especialidadValue').textContent = datosActualizados.especialidad || 'No especificada';
                    document.getElementById('colegiaturaValue').textContent = datosActualizados.colegiatura || 'No especificado';
                    document.getElementById('telefonoValue').textContent = datosActualizados.telefono || 'No especificado';
                    document.getElementById('direccionValue').textContent = datosActualizados.direccion || 'No especificada';
                    
                    // Mostrar mensaje de éxito
                    mostrarExito();
                } else {
                    mostrarError(data.message || 'Ha ocurrido un error al actualizar los datos.');
                }
            } catch (error) {
                console.error('Error completo:', error);
                mostrarError('Error de conexión. Por favor, inténtelo de nuevo más tarde. Revise la consola para más detalles.');
            }
        }
        
        // Función para mostrar mensaje de éxito
        function mostrarExito() {
            const alertSuccess = document.getElementById('alertSuccess');
            alertSuccess.style.display = 'block';
            
            // Ocultar después de 5 segundos
            setTimeout(() => {
                alertSuccess.style.display = 'none';
            }, 5000);
        }
        
        // Función para mostrar mensaje de error
        function mostrarError(mensaje) {
            const alertError = document.getElementById('alertError');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = mensaje;
            alertError.style.display = 'block';
            
            // Ocultar después de 5 segundos
            setTimeout(() => {
                alertError.style.display = 'none';
            }, 5000);
        }
        
        // Función para obtener cookies
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }
    </script>
</body>
</html>
